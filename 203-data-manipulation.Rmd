---
title: "Manipulaci칩n de datos"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Data analysis is the process by which data becomes understanding, knowledge and insight

## Control Structures

### Hoy veremos

* `if`,`else`,`for`,`while`,`repeat`,`break`,`next`,`return`

#### if, else

This is an R Markdown format used for publishing markdown documents to GitHub. When you click the **Knit** button all R code chunks are run and a markdown file (.md) suitable for publishing to GitHub is generated.


```{r}

setwd("~/Documents/GitHub/R-Introductory-Course")
suppressMessages(library(dplyr, quietly = T))
library(ggplot2, quietly = T)

flights <- tbl_df(read.csv("data/flights.csv", stringsAsFactors = FALSE))
flights$date <- as.Date(flights$date)

weather <- tbl_df(read.csv("data/weather.csv", stringsAsFactors = FALSE))
weather$date <- as.Date(weather$date)

planes <- tbl_df(read.csv("data/planes.csv", stringsAsFactors = FALSE))

airports <- tbl_df(read.csv("data/airports.csv", stringsAsFactors = FALSE))

flights
weather
planes
airports
for (obj in ls()) { 
  message(obj); 
  print(object.size(get(obj)), units='auto')
  }
```
Primeros verbos
* `filter`,`select`,`for`,`arrange`,`mutate`,`summarise`

#### filter

**Ejemplo:**
```{r}
sfo <- filter(flights, dest == "SFO")
qplot(date, dep_delay, data = sfo)
qplot(date, arr_delay, data = sfo)
qplot(arr_delay, dep_delay, data = sfo)
```
**Gr치ficos de frecuencia**
```{r}
qplot(dep_delay, data = flights, binwidth = 10)
qplot(dep_delay, data = flights, binwidth = 1) + xlim(0, 250)
```

#### group_by y summarise

```{r}
by_day <- group_by(flights, date)
by_day
daily_delay <- summarise(by_day, 
  dep = mean(dep_delay, na.rm = TRUE),
  arr = mean(arr_delay, na.rm = TRUE)
)
qplot(date, dep, data = daily_delay, geom = "line")
qplot(date, arr, data = daily_delay, geom = "line")
```

#### encadenando con pipes: %>% 

**Opci칩n 1**
```{r}
hourly_delay <- filter(
  summarise(
    group_by(
      filter(flights, !is.na(dep_delay)), 
      date, hour), 
    delay = mean(dep_delay), 
    n = n()), 
  n > 10
)
```

**Opci칩n 2**
```{r}
hourly_delay <- flights %>% 
  filter(!is.na(dep_delay)) %>%
  group_by(date, hour) %>%
  summarise(
    delay = mean(dep_delay),
    n = n()
  ) %>% 
  filter(n > 10)
```




#### Ejercicios:
```{r eval=F}
flights %>%
  group_by(dest) %>%
  summarise(arr_delay = mean(arr_delay, na.rm = TRUE), n = n()) %>%
  arrange(desc(arr_delay))

flights %>% 
  group_by(carrier, flight, dest) %>% 
  tally(sort = TRUE) %>%
  filter(n == 365)

flights %>% 
  group_by(carrier, flight, dest) %>% 
  filter(n() == 365)

per_hour <- flights %>%
  filter(cancelled == 0) %>%
  mutate(time = hour + minute / 60) %>%
  group_by(time) %>%
  summarise(arr_delay = mean(arr_delay, na.rm = TRUE), n = n())

qplot(time, arr_delay, data = per_hour)
qplot(time, arr_delay, data = per_hour, size = n) + scale_size_area()
qplot(time, arr_delay, data = filter(per_hour, n > 30), size = n) + scale_size_area()

ggplot(filter(per_hour, n > 30), aes(time, arr_delay)) + 
  geom_vline(xintercept = 5:24, colour = "white", size = 2) +
  geom_point()
```

#### ranking, lead, lag

```{r}


# Motivating examples ----------------------------------------------------------

planes <- flights %>%
  filter(!is.na(arr_delay)) %>%
  group_by(plane) %>%
  filter(n() > 30)

planes %>%
  mutate(z_delay = (arr_delay - mean(arr_delay)) / sd(arr_delay)) %>%
  filter(z_delay > 5)

planes %>% filter(min_rank(arr_delay) < 5)

# Ranking functions ------------------------------------------------------------

min_rank(c(1, 1, 2, 3))
dense_rank(c(1, 1, 2, 3))
row_number(c(1, 1, 2, 3))

flights %>% group_by(plane) %>% filter(row_number(desc(arr_delay)) <= 2)
flights %>% group_by(plane) %>% filter(min_rank(desc(arr_delay)) <= 2)
flights %>% group_by(plane) %>% filter(dense_rank(desc(arr_delay)) <= 2)

# Lead and lag -----------------------------------------------------------------

daily <- flights %>% 
  group_by(date) %>% 
  summarise(delay = mean(dep_delay, na.rm = TRUE))

daily %>% mutate(delay - lag(delay))
daily %>% mutate(delay - lag(delay))

```


